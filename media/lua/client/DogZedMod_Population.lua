--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]



DogZedMod = DogZedMod or {}



DogZedMod.CorpseCheck = {
    ['Base.RadiatedDog']={["isDogCorpse"]=true, ["drop"]="Base.RadiatedDog_Dead_"},
    ['Base.ShadowDog']={["isDogCorpse"]=true, ["drop"]="Base.ShadowDog_Dead_"},
    ['Base.CloneDog']={["isDogCorpse"]=true, ["drop"]="Base.CloneDog_Dead_"},
}






function DogZedMod.getCorpseFtype(zed)
    local visuals = zed:getItemVisuals()
    local fType
    local textures = {}
    for i = 0, visuals:size() - 1 do
        local visual = visuals:get(i)
        local clo = visual:getClothingItem()
        local cloName = visual:getClothingItemName()

        if cloName == "RadiatedDog" or cloName == "ShadowDog" then
            local choice = visual:getTextureChoice()
            local textureChoicesStr = tostring(clo:getTextureChoices())  --  userdata
            local searchStr = tostring(cloName).."_Texture_[A-F]"
            for texture in string.gmatch(textureChoicesStr, searchStr) do
                table.insert(textures, texture)
            end
            local textName = textures[choice + 1]
            if textName then
				local pose = ZombRand(1,4)
                local letter = string.upper(string.sub(textName, -1))  -- last letter
                fType = tostring(cloName).."_Dead_"..tostring(letter)..tostring(pose)
            end
        end
    end
    return fType
end

--print(getCorpseToSpawn(dbgZed))


function DogZedMod.handleCorpse(corpse)
    if  DogZedMod.isDeadDog(corpse) or corpse:getModData()['DogZed_fType']  then
        local tab = DogZedMod.CorpseCheck
        local w = corpse:getWornItems()
        for i = 0, w:size() - 1 do
            local item = w:getItemByIndex(i)
            if item then
                local fType = item:getName()
                if fType and tab[fType] then
                    local isDogCorpse = tab[fType].isDogCorpse
                    if isDogCorpse then
                        --local drop = tostring(tab[fType].drop)..tostring(ZombRand(1,5))
                        local drop = corpse:getModData()['DogZed_fType']
                        local sq = corpse:getSquare()
                        if sq then
                            if fType ~= "Base.CloneDog" then
                                sq:AddWorldInventoryItem(tostring(drop), ZombRand(0, 1.5), ZombRand(0, 1.5), 0)
                                DogZedMod.SpawnRewards(sq)
                            end
                            if fType == "Base.RadiatedDog" then
                                DogZedMod.setRadiateArea(sq)
                            end
                            sq:removeCorpse(corpse, isClient())
                        end
                    end
                end
            end
        end
    end
end

function DogZedMod.CorpseCleaner()
    local rad = 8
    local pl = getPlayer(); if not pl then return end
    local cell = pl:getCell()
    local x, y, z = pl:getX(), pl:getY(), pl:getZ()
    for xDelta = -rad, rad do
        for yDelta = -rad, rad do
            local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
            if sq then
                local corpse = IsoObjectPicker.Instance:PickCorpse(sq:getX(), sq:getY()) or sq:getDeadBody()
                if corpse and instanceof(corpse, "IsoDeadBody") then
                    DogZedMod.handleCorpse(corpse)
                end
            end
        end
    end
end
Events.EveryOneMinute.Remove(DogZedMod.CorpseCleaner)
Events.EveryOneMinute.Add(DogZedMod.CorpseCleaner)


function DogZedMod.isDeadDog(corpse)
	if not corpse or not instanceof(corpse, "IsoDeadBody") then return false end
    if corpse:getModData()['DogZed_Init'] then return true end
    local fit = tostring(corpse:getOutfitName())
    if fit == DogZedMod.outfit1 then return true end
    if fit == DogZedMod.outfit2 then return true end
    if fit == DogZedMod.outfit0 then return true end
	return false
end

-----------------------            ---------------------------

function DogZedMod.getSpawnRandomZedInfo(fit)
    local maleOutfits = getAllOutfits(false)
    local femaleOutfits = getAllOutfits(true)
    local allOutfits = {}

    for i = 0, maleOutfits:size() - 1 do
        table.insert(allOutfits, maleOutfits:get(i))
    end
    for i = 0, femaleOutfits:size() - 1 do
        table.insert(allOutfits, femaleOutfits:get(i))
    end

    if not fit or fit == '' then
        fit = allOutfits[ZombRand(#allOutfits) + 1]
    end

    local outfitExists = false
    for _, outfit in ipairs(allOutfits) do
        if outfit == fit then
            outfitExists = true
            break
        end
    end

    if not outfitExists then
        fit = allOutfits[ZombRand(#allOutfits) + 1]
    end

    if maleOutfits:contains(fit) and femaleOutfits:contains(fit) then
        return fit, 0
    elseif femaleOutfits:contains(fit) then
        return fit, 100
    else
        return fit, 0
    end
end

function DogZedMod.doDespawn(zed)
    if zed:isAlive() then
        zed:setAvoidDamage(false)
        zed:changeState(ZombieOnGroundState.instance())
        zed:setAttackedBy(getCell():getFakeZombieForHit())
        zed:becomeCorpse()

--[[         zed:removeFromWorld();
        zed:removeFromSquare(); ]]
--[[     else
        local sq = zed:getSquare()
        sq:removeCorpse(zed, isClient()); ]]
    end
end

function DogZedMod.doSpawn(sq, isDown, outfit)
    if sq then
        local x, y, z = sq:getX(), sq:getY(), sq:getZ()
        if isClient() then

            local fit, fChance = DogZedMod.getSpawnRandomZedInfo()

            if outfit and outfit ~= '' then
                fit, fChance = DogZedMod.getSpawnRandomZedInfo(outfit)
            end
            sendClientCommand('DogZedMod', 'doSpawn', {x = x, y = y, z = z, count = 1, fit = fit, fChance = fChance, isDown = isDown})
        else
            addZombiesInOutfit(x, y, z, 1, tostring(fit), 100, false, false, false, false, 2);
        end
    end
end

function DogZedMod.doLocalSpawn(sq, outfit)
	local pl = getPlayer()
	local sq = pl:getSquare():getAdjacentSquare(pl:getDir());

    if sq then
        if isClient() then
            SendCommandToServer(string.format("/createhorde2 -x %d -y %d -z %d -count %d -radius %d -crawler %s -isFallOnFront %s -isFakeDead %s -knockedDown %s -health %s -outfit %s ", sq:getX(), sq:getY(), sq:getZ(), 1, 4, tostring(true), tostring(true), tostring(false), tostring(true), tostring(2), "Overgrown"))
            return
        end
	end
    addZombiesInOutfit(x, y, z, 1, tostring(fit), 100, false, false, false, false, 2);
end


function DogZedMod.getPackAlpha()
    local cell = getPlayer():getCell()
    local zombies = cell:getZombieList()
    if zombies:isEmpty() then return nil end

    local lowestZombie = nil
    local lowestNumber = math.huge

    for i = 0, zombies:size() - 1 do
        local zed = zombies:get(i)
        if DogZedMod.isDogZed(zed) then
            local zombieID = zed:getOnlineID()
            local zombieNumber = zombieID
            if zombieNumber < lowestNumber then
                lowestNumber = zombieNumber
                lowestZombie = zed
            end
        end
    end

    return lowestZombie
end


function DogZedMod.AlphaFollower(zed)
    if not SandboxVars.DogZedMod.PackMentality  then return end
    if not DogZedMod.isDogZed(zed) then return end
    if not DogZedMod.isClosestPl(getPlayer(), zed) then return end
    local alpha = DogZedMod.getPackAlpha()
    if not alpha then return end
    if alpha == zed then return end
    local x, y, z = round(alpha:getX()),  round(alpha:getY()),  alpha:getZ()
    if not DogZedMod.isAggro(zed)  then
        if DogZedMod.getDistanceBetween(alpha, zed) > 12 then
            DogZedMod.moveToXYZ(zed, x, y, z)
            if getCore():getDebug() then
                zed:addLineChatElement('following alpha')
            end
        else
            if DogZedMod.getDistanceBetween(alpha, zed) <= 3 then
                local randX = x + ZombRand(-4, 4)
                local randY = y + ZombRand(-4, 4)

                DogZedMod.stopWalking(zed)
                DogZedMod.moveToXYZ(zed, randX, randY, z)

            end
                --zed:faceLocation(x, y);
        end
    end
end
Events.OnZombieUpdate.Remove(DogZedMod.AlphaFollower)
Events.OnZombieUpdate.Add(DogZedMod.AlphaFollower)
