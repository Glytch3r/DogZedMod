--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


require "lua_timers"

DogZedMod.Highlighter = {}
DogZedMod.Highlighter.__index = DogZedMod.Highlighter


function DogZedMod.getEffectsDecay()
    return SandboxVars.DogZedMod.EffectsDecay or 5
end


function DogZedMod.Highlighter:new(sq)
    local instance = setmetatable({}, self)
    instance.sq = sq
    instance.ticks = 0
    return instance
end

function DogZedMod.Highlighter:tck()
    self.ticks = self.ticks + 1
    if self.ticks % 9 == 0 then
        self.ticks = 0

        local num1 = DogZedMod.normalizeTo100(ZombRand(1, 60), 0, 60) / 100
        local num2 = DogZedMod.normalizeTo100(ZombRand(1, 60), 0, 60) / 100
        local num3 = DogZedMod.normalizeTo100(ZombRand(1, 60), 0, 60) / 100

        local m1 =  getWorldMarkers():addGridSquareMarker(   "circle_only_highlight_2",      "",      self.sq,    0,      0.3,    0,  true,   num1   )
        local m2 = getWorldMarkers():addGridSquareMarker(   "circle_only_highlight_2",      "",      self.sq,    0,      0.6,    0,  true,   num2   )
        local m3 = getWorldMarkers():addGridSquareMarker(   "circle_only_highlight_2",      "",      self.sq,    0,      1,      0,  true,   num3   )

        timer:Simple(0.5, function()
            m1:remove()
            m2:remove()
            m3:remove()
        end)
    end
end

function DogZedMod.Highlighter:start()
    self.onTickFunction = function() self:tck() end
    Events.OnTick.Add(self.onTickFunction)
    local decay = DogZedMod.getEffectsDecay()
    timer:Simple(decay, function()
        self:stop()
    end)
end

function DogZedMod.Highlighter:stop()
    Events.OnTick.Remove(self.onTickFunction)
end

function DogZedMod.addHL(targ)
    local decay = DogZedMod.getEffectsDecay()/3
    local count = 3
    local sq = targ:getSquare()
    local function readdHL(count)
        local highlighterInstance = DogZedMod.Highlighter:new(sq)
        highlighterInstance:start()

        timer:Simple(decay, function()
            count = count - 1
            if highlighterInstance then
                highlighterInstance:stop()
                highlighterInstance = nil
            end
            if count > 0 then
                readdHL(count)
            end
        end)
    end
    readdHL(count)
end

local function doRadiate(obj, activate)
    local decay = DogZedMod.getEffectsDecay()
    if activate then
        obj:setHighlighted(true, false);

    timer:Simple(decay, function()
        obj:setHighlighted(false);
        obj:setOutlineHighlight(false);
    end)

    else
        obj:setHighlighted(false);
        obj:setOutlineHighlight(false);
        return
    end



    local col = ColorInfo.new(0, 1, 0.2, 0.001);
    obj:setHighlightColor(col);
    obj:setOutlineHighlightCol(col);
    obj:setBlink(true);
    obj:setOutlineHlBlink(true);
    obj:setOutlineThickness(0.001);
    obj:setOutlineHighlight(true);
end

function DogZedMod.setRadiateSq(targOrSq)
    local decay = DogZedMod.getEffectsDecay()
    if not targOrSq then targOrSq:getSquare() end
    if targOrSq then
        for i=0, targOrSq:getObjects():size()-1 do
            local obj = targOrSq:getObjects():get(i)
            if obj and instanceof(obj, "IsoObject") then
                local flr = targOrSq:getFloor()
                if flr and flr ~= obj then
                    if DogZedMod.doRoll(35) then
                        doRadiate(obj, true)
                    end
                end
            end
        end
    end
end

function DogZedMod.setRadiateArea(targOrSq)
    local count = 0
    local rad = 3
    local cell = getCell()
    local x, y, z = targOrSq:getX(), targOrSq:getY(), targOrSq:getZ()
    for xDelta = -rad, rad do
        for yDelta = -rad, rad do
            local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
            if sq then
                DogZedMod.setRadiateSq(sq)
            end
        end
    end
end

function DogZedMod.getRandSq(centerPoint, areaMultiplier)
    if not centerPoint then centerPoint = getPlayer():getSquare() end
    local minRad = 1 * areaMultiplier
    local maxRad = 2 * areaMultiplier



    local cell = getCell()
    local x = centerPoint:getX()
    local y = centerPoint:getY()
    local z = centerPoint:getZ()

    local nearbySquare = nil

    repeat
        local offsetX = ZombRand(-maxRad, maxRad + 1)
        local offsetY = ZombRand(-maxRad, maxRad + 1)

        local newX = x + offsetX
        local newY = y + offsetY

        local distance = math.sqrt(offsetX^2 + offsetY^2)

        if distance >= minRad and distance <= maxRad then
            nearbySquare = cell:getOrCreateGridSquare(newX, newY, z)
        end
    until nearbySquare

    return nearbySquare
end
