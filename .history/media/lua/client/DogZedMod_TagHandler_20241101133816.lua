--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


require "lua_timers"
DogZedMod = DogZedMod or {}

function DogZedMod.isShowTag()
    return SandboxVars.DogZedMod.ShowTag or getCore():getDebug()
end

function DogZedMod.isTagEmpty(targ)
    return tostring(targ:getChildSprites())  == '[]'
end
function DogZedMod.isHasTag(targ)
    return not DogZedMod.isTagEmpty(targ)
end


function DogZedMod.removeTag(targ)
    targ:clearAttachedAnimSprite()
end




function DogZedMod.setTag(targ, int)

    if DogZedMod.isShowTag() then
        if targ then
            if DogZedMod.isDogChar(targ) then

                if int == nil and  DogZedMod.isDogZed(targ) then
                    int = DogZedMod.getOutfitNum(targ) or DogZedMod.getAdminSkinNum(targ)

                    if int == 2 then
                        if SandboxVars.DogZedMod.SameShadowCloneTag then
                            int = 1
                        end
                    end

                end


                if DogZedMod.isHasTag(targ) then
                    DogZedMod.removeTag(targ)
                end

                local spr = getSprite("media/ui/Tags/DogZed_tag_"..tostring(int)..".png"):newInstance()
                targ:setAttachedAnimSprite(ArrayList.new())
                local anm = targ:getAttachedAnimSprite():add(spr)

            end
        end
    end
end

function DogZedMod.clearStatsToAll()
    local zombies = getCell():getZombieList()
    if not getCell() or not zombies then return end
    for i = 0, zombies:size() - 1 do
        local zed = zombies:get(i)
        if zed and DogZedMod.isDogZed(zed) then
            zed:getModData()['DogZed_Init'] = nil
            DogZedMod.removeTag(zed)
        end
    end
end


-----------------------            ---------------------------


DogZedMod.Highlighter = {}
DogZedMod.Highlighter.__index = DogZedMod.Highlighter

function DogZedMod.Highlighter:new(sq)
    local instance = setmetatable({}, self)
    instance.sq = sq
    instance.ticks = 0
    return instance
end

function DogZedMod.Highlighter:tck()

    self.ticks = self.ticks + 1
    if self.ticks % 9 == 0 then
        self.ticks = 0

        local num1 = DogZedMod.normalizeTo100(ZombRand(1, 60), 0, 60) / 100
        local num2 = DogZedMod.normalizeTo100(ZombRand(1, 60), 0, 60) / 100
        local num3 = DogZedMod.normalizeTo100(ZombRand(1, 60), 0, 60) / 100
        local r, g, b = 0.514, 0.965, 0.694
        local m = getWorldMarkers():addGridSquareMarker("circle_only_highlight_2", "", self.sq, r, g, b,  true, num1)
        local m2 = getWorldMarkers():addGridSquareMarker("circle_only_highlight_2", "", self.sq, r, g, b,  true, num2)
        local m3 = getWorldMarkers():addGridSquareMarker("circle_only_highlight_2", "", self.sq, r, g, b,  true, num3)

        timer:Simple(0.5, function()
            m:remove()
            m2:remove()
            m3:remove()
        end)
    end
end

function DogZedMod.Highlighter:start()
    self.onTickFunction = function() self:tck() end
    Events.OnTick.Add(self.onTickFunction)
    timer:Simple(3, function()
        self:stop()
    end)
end




function DogZedMod.Highlighter:stop()
    Events.OnTick.Remove(self.onTickFunction)
end


--[[
--[[
        local cell = getCell()
        local RadGlow = nil
        local sq = targ:getCurrentSquare()
        local x, y, z = sq:getX(), sq:getY(), sq:getZ()
        if x and y and z then
            RadGlow = IsoLightSource.new(x, y, z, 131, 246, 177,  ZombRand(0, 256))
        end
        cell:addLamppost(RadGlow)
        if RadGlow then
            cell:removeLamppost(RadGlow)
        end
 ]]
function DogZedMod.addHLtoSq(targ)
    local count = 3
    local function reAddHLtoSq(count)
        local highlighterInstance = DogZedMod.Highlighter:new(sq)
        highlighterInstance:start()


        timer:Simple(1, function()
            count = count - 1

            if highlighterInstance then
                highlighterInstance:stop()
                highlighterInstance = nil
            end
            if count > 0 then
                reAddHLtoSq(count)
            else
                targ:startMuzzleFlash()
                DogZedMod.setOutline(targ, true)
            end
        end)
    end
    DogZedMod.setOutline(targ, true)
    reAddHLtoSq(count)

end
function DogZedMod.setOutline(targ, isBlink)
    if targ == nil then return end
    targ:setOutlineHighlight(true)
    targ:setOutlineHlBlink(isBlink)
    targ:setOutlineThickness(0.03)
    targ:setOutlineHighlightCol(131, 246, 177,  ZombRand(0, 256))
end


--[[


DogZedMod.addHLtoSq(getPlayer())


 ]]

--[[
function DogZedMod.RadiationMarkers(sq)
    local pl = getPlayer(); if not pl then return end
	local zombies = getCell():getObjectList()
	for i=zombies:size(),1,-1 do
		local zed = zombies:get(i-1)
		if DogZedMod.isRadiatedDog(zed) then
            if DogZedMod.isShouldRadiate(zed, pl) then
                local sq = zed:getSquare()
                if sq then
                    DogZedMod.addHLtoSq(sq)
                end
            end
		end
	end
end
Events.OnClockUpdate.Remove(DogZedMod.RadiationMarkers)
Events.OnClockUpdate.Add(DogZedMod.RadiationMarkers)


 ]]







-----------------------            ---------------------------
--[[
function DogZedMod.dayShift(timeOfDay)
    if timeOfDay == "Day" then
		if getCore():getDebug() then
			print("DogZedMod: It's now daytime!")
		end
		DogZedMod.setStatsToAll()
    elseif timeOfDay == "Night" then

		if getCore():getDebug() then
			print("DogZedMod: It's now nighttime!")
		end
		DogZedMod.setStatsToAll()
    end
end

Events.OnDayTimeChange.Add(DogZedMod.dayShift)
Events.EveryTenMinutes.Add(DogZedMod.checkDayTimeChange)


function DogZedMod.checkDayTimeChange()
    if not DogZedMod.lastDayTime then
        DogZedMod.lastDayTime = DogZedMod.getDayTime()
    end

    local currentDayTime = DogZedMod.getDayTime()

    if currentDayTime ~= DogZedMod.lastDayTime then
        triggerEvent("OnDayTimeChange", currentDayTime)
        DogZedMod.lastDayTime = currentDayTime
    end
end

 ]]