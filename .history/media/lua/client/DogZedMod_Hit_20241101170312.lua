--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

DogZedMod = DogZedMod or {}


-----------------------               ---------------------------


function DogZedMod.getAbsorbDmgChance()
	local chance = SandboxVars.DogZedMod.AbsorbDmgChance
	if chance == 0 then return false  end
	if chance == 100 then return true end
	return DogZedMod.doRoll(chance)
end


function DogZedMod.getVarHP(zed)
	return SandboxVars.DogZedMod.HP or 12
end

function DogZedMod.hitZed(zed, pl, part, wpn)

	if not DogZedMod.isDogZed(zed) then return end


	if DogZedMod.isShadowClone(zed)  then
		DogZedMod.doDespawn(zed)
	end


	local absorb =  DogZedMod.getAbsorbDmgChance()
	zed:setAvoidDamage(absorb)
	if absorb then
		DogZedMod.addHL(zed)
		zed:setVariable("HitReaction", "Dog_HitReact")
		local varHP = DogZedMod.getVarHP(zed)
		local healthDmg = 3 / varHP
		zed:setHealth(zed:getHealth()-healthDmg)
	end

	if pl == getPlayer() then
		zed:getEmitter():stopAll()
	end

	if isDebugEnabled() then
		--zed:addLineChatElement(tostring(zed:getPlayerAttackPosition()))
		zed:addLineChatElement(tostring(round(zed:getHealth())))
	end

	--[[ 	if zed:getPlayerAttackPosition() == 'BEHIND' then
			zed:setVariable("hitreaction", "HitReact")
		end
	]]
end
Events.OnHitZombie.Remove(DogZedMod.hitZed)
Events.OnHitZombie.Add(DogZedMod.hitZed)



if DogZedMod.isRadiatedDog(zed) then  DogZedMod.setRadiateSq(sq) end
    local areaMultiplier = ZombRAnd(1, 3)
    DogZedMod.getRandSq(sq, areaMultiplier)
    DogZedMod.setRadiateArea(zed)
    DogZedMod.addHL(zed)
    DogZedMod.setRadiateSq(sq)
end

function DogZedMod.InjuryRoll(pl)
	local InjuryChance = SandboxVars.DogZedMod.InjuryChance
	if InjuryChance == 0 then return false end
	if DogZedMod.isRadiatedDog(zed) then  DogZedMod.setRadiateSq(sq) end
	return DogZedMod.doRoll(InjuryChance)
end

function DogZedMod.getRandPart(pl)
	return pl:getBodyDamage():getBodyPart(BodyPartType.FromIndex(ZombRand(BodyPartType.ToIndex(BodyPartType.MAX))));
end


function DogZedMod.doPain(pl)
	local part = DogZedMod.getPart(pl)
	local DogZedPain = part:getAdditionalPain()
	if DogZedPain > 0 then
		local max = 101-DogZedPain
		local roll = DogZedPain + ZombRand(1, max)
		part:setAdditionalPain(roll)
	else
		part:setAdditionalPain(ZombRand(1, 101))
	end
end


function DogZedMod.getPart(pl)
	local bdDmg = pl:getBodyDamage()
	local parts = {
		[1]=bdDmg:getBodyPart(BodyPartType.Groin),
		[2]=bdDmg:getBodyPart(BodyPartType.LowerLeg_L),
		[3]=bdDmg:getBodyPart(BodyPartType.LowerLeg_R),
		[4]=bdDmg:getBodyPart(BodyPartType.UpperLeg_L),
		[5]=bdDmg:getBodyPart(BodyPartType.UpperLeg_R),
		[6]=bdDmg:getBodyPart(BodyPartType.Torso_Lower),
	}
	return parts[ZombRand(1,7)]
end


function DogZedMod.InjuryRoll(pl)
	local InjuryChance = SandboxVars.DogZedMod.InjuryChance
	if InjuryChance == 0 then return false end
	return DogZedMod.doRoll(InjuryChance)
end

function DogZedMod.doDmg(pl)
	local minDmg = SandboxVars.DogZedMod.MinDmg
	local maxDmg = SandboxVars.DogZedMod.MaxDmg
	local part = DogZedMod.getPart(pl)
	part:AddDamage(ZombRand(minDmg, maxDmg+1))
	DogZedMod.setRadiateArea(pl)
end



function DogZedMod.doInjury(targ)
	if instanceof(targ, "IsoPlayer") then
		local part = DogZedMod.getRandPart(targ)
		if DogZedMod.doRoll(50) then
			local dmgTime = part:getCutTime()
			if dmgTime > 0 then
				local max = 101-dmgTime
				local roll = dmgTime + ZombRand(1, max)
				part:setCutTime(roll)
			end
			part:setCut(true);
		else
			local dmgTime = part:getScratchTime()
			if dmgTime > 0 then
				local max = 101-dmgTime
				local roll = dmgTime + ZombRand(1, max)
				part:setScratchTime(roll)
			end
			part:setScratched(true, false);
		end
	end
end



function DogZedMod.attackOutput(pl)
	if DogZedMod.doRoll(50) then
		DogZedMod.doDmg(pl)
	else
		DogZedMod.doPain(pl)
	end
end

function DogZedMod.hit(zed, pl, wpn, HP)
	if not zed then return end
	if not instanceof(zed, 'IsoZombie') then return end
	if DogZedMod.isDogZed(zed) and pl == getPlayer() then
		if DogZedMod.isMaxPanic() then
			DogZedMod.doDrop(pl)
		end
		if zed:isCriticalHit() then
			if DogZedMod.InjuryRoll(pl) then
				DogZedMod.doInjury(pl)
			end
		end
		DogZedMod.attackOutput(pl)
	end

end
Events.OnWeaponHitCharacter.Remove(DogZedMod.hit)
Events.OnWeaponHitCharacter.Add(DogZedMod.hit)



function DogZedMod.isMaxPanic()
	local pl = getPlayer(); if not pl then return end
	local stats = pl:getStats()
	local panic = stats:getPanic()
	return panic >= 99
end


function DogZedMod.doDrop(pl)
	local pr = pl:getPrimaryHandItem()
	if not pr then return end
	if tostring(WeaponType.getWeaponType(pl)) == 'barehand' or  pr:getCategories():contains("Unarmed") then return end
	pl:fallenOnKnees()
end
