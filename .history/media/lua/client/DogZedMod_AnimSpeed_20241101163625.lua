--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]



DogZedMod = DogZedMod or {}

function DogZedMod.setAnimSpeed(zed, int)
    if not int then
        int = DogZedMod.getAnimSpeed(zed)
    end
    if zed:getVariableString('AnimSpeed') ~= tostring(int) then
        zed:setVariable('AnimSpeed', tostring(int))
    end
end

function DogZedMod.isDataSender(zed)
    if not DogZedMod.isAggro(zed) then
        return false
    else
        local targ = zed:getTarget()
        if targ == getPlayer() and zed:isTargetVisible() then
            return true
        end
    end
end
function DogZedMod.getAnimSpeed(zed)
    local min = DogZedMod.getMinAnimSpeed()
    local max = DogZedMod.getMaxAnimSpeed()
    local AnimSpeed = min
    if DogZedMod.isAggro(zed) then
        local num = DogZedMod.getOutfitNum(zed)
        if num == 0 then
            AnimSpeed =  tonumber(DogZedMod.getRadiatedDogAnimSpeed(zed))
        else
            AnimSpeed =  tonumber(DogZedMod.getShadowDogAnimSpeed(zed))
        end
    end
    local res =  math.max(min, math.min(max, AnimSpeed)) or min
    return tonumber(res)
end


-----------------------            ---------------------------
function DogZedMod.getMinAnimSpeed()
    return SandboxVars.DogZedMod.MinAnimSpeed or 3
end

function DogZedMod.getMaxAnimSpeed()
    return SandboxVars.DogZedMod.MaxAnimSpeed or 7
end

function DogZedMod.getShadowDogAnimSpeed(zed)
    if not DogZedMod.isDataSender(zed) then return DogZedMod.getMinAnimSpeed() end
    local res = DogZedMod.getPanic()
    return res / 10
end

function DogZedMod.getRadiatedDogAnimSpeed(zed)
    if not DogZedMod.isDataSender(zed) then return DogZedMod.getMinAnimSpeed() end
    local res = DogZedMod.getTotalBloodLevel()
    return res  / 10
end


-----------------------            ---------------------------
function DogZedMod.getPanic()
	local pl = getPlayer()
	local stats = pl:getStats()
	local panic = stats:getPanic()
	return panic
end


-----------------------          ---------------------------

function DogZedMod.getWornBloodLevel()
    local pl = getPlayer()
    local wornItems = pl:getWornItems()
    local itemBlood = 0
    local wornCount = 0
    local res = 0

    if wornItems ~= nil and wornItems:size() > 0 then
        for i = 0, wornItems:size() - 1 do
            local item = wornItems:getItemByIndex(i)
            if instanceof(item, "Clothing") then
                if item:getBloodClothingType() ~= nil then
                    local currentItemBlood = item:getBloodLevel() or 0
                    if currentItemBlood > 0 then
                        wornCount = wornCount + 1
                        itemBlood = itemBlood + currentItemBlood
                    end
                end
            end
        end

        if wornCount > 0 then
            res = itemBlood / wornCount
        end
    end

    return res > 0 and round(res) or 0
end

-----------------------            ---------------------------

function DogZedMod.getBodyBloodLevel()
    local pl = getPlayer()
    local vis = pl:getHumanVisual()
    local level = 0
    local maxLevel = BloodBodyPartType.MAX:index()

    for i = 0, maxLevel - 1 do
        local bloodLevel = tonumber(vis:getBlood(BloodBodyPartType.FromIndex(i)))
        level = level + bloodLevel
    end
    if level > 0 then
        local res = (level / maxLevel) * 100
        return round(tonumber(res))
    end
    return 0
end

-----------------------            ---------------------------
function DogZedMod.getTotalBloodLevel()
    local pl = getPlayer()
    local wornLvl = DogZedMod.getWornBloodLevel()
    local bodyLvl = DogZedMod.getBodyBloodLevel()
    if wornLvl == 0 then
        return round(bodyLvl)
    elseif bodyLvl == 0 then
        return round(wornLvl)
    else
        local res = (wornLvl + bodyLvl) / 2
        return round(res)
    end
end

--[[
    print(DogZedMod.getWornBloodLevel())
    print(DogZedMod.getBodyBloodLevel())
    print(DogZedMod.getTotalBloodLevel())
    DogZedMod.checkBloodLevel(90)
 ]]
-----------------------            ---------------------------
--[[
Math:
The blood level across all worn clothing items, averaged by the number of clothing pieces that have blood.
The sum of blood levels across all body parts, divided by the total number of body parts.
If both wornLvl and bodyLvl are greater than zero, the total blood level is the average of both:
If either wornLvl or bodyLvl is zero, the total is the non-zero value.

worn blood level = ∑ Wornitems Bloodlevels  / number of bloody clothes
body blood level = (∑ Bodyparts Bloodlevels / Bodyparts ) * 100

TOTAL = (worn blood level  +  total body blood level)  /  2

 ]]