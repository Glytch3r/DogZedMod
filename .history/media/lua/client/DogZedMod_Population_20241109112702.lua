--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]



DogZedMod = DogZedMod or {}



DogZedMod.CorpseReplacement = {
    ['Base.RadiatedDog']={["isDogCorpse"]=true, ["drop"]="Base.RadiatedDog_Dead_"},
    ['Base.ShadowDog_1']={["isDogCorpse"]=true, ["drop"]="Base.ShadowDog_Dead_A_"},
    ['Base.CloneDog']={["isDogCorpse"]=true, ["drop"]="Base.ShadowDog_Dead_B_"},
}



function DogZedMod.handleCorpse(corpse)
    local tab = DogZedMod.CorpseReplacement
    local w = corpse:getWornItems()
    for i = 0, w:size() - 1 do
        local item = w:getItemByIndex(i)
        if item then
            local fType = item:getName()
            if fType and tab[fType] then
                local isDogCorpse = tab[fType].isDogCorpse
                if isDogCorpse then
                    local drop = tostring(tab[fType].drop)..tostring(ZombRand(1,4))
                    local sq = corpse:getSquare()
                    if sq then
                        if fType ~= "Base.CloneDog" then
                            DogZedMod.SpawnRewards(sq)
                            sq:AddWorldInventoryItem(tostring(drop), ZombRand(0, 1.5), ZombRand(0, 1.5), 0)
                        end
                        if fType == "Base.RadiatedDog" then
                            DogZedMod.setRadiateArea(sq)
                        end
                        sq:removeCorpse(corpse, isClient())
                    end
                end
            end
        end
    end
end

function DogZedMod.CorpseCleaner()
    local rad = 8
    local pl = getPlayer(); if not pl then return end
    local cell = pl:getCell()
    local x, y, z = pl:getX(), pl:getY(), pl:getZ()
    for xDelta = -rad, rad do
        for yDelta = -rad, rad do
            local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
            if sq then
                local corpse = IsoObjectPicker.Instance:PickCorpse(sq:getX(), sq:getY()) or sq:getDeadBody()
                if corpse and instanceof(corpse, "IsoDeadBody") then
                    DogZedMod.handleCorpse(corpse)
                end
            end
        end
    end
end
Events.EveryOneMinute.Remove(DogZedMod.CorpseCleaner)
Events.EveryOneMinute.Add(DogZedMod.CorpseCleaner)
-----------------------            ---------------------------

function DogZedMod.getSpawnRandomZedInfo(fit)
    local maleOutfits = getAllOutfits(false)
    local femaleOutfits = getAllOutfits(true)
    local allOutfits = {}

    for i = 0, maleOutfits:size() - 1 do
        table.insert(allOutfits, maleOutfits:get(i))
    end
    for i = 0, femaleOutfits:size() - 1 do
        table.insert(allOutfits, femaleOutfits:get(i))
    end

    if not fit or fit == '' then
        fit = allOutfits[ZombRand(#allOutfits) + 1]
    end

    local outfitExists = false
    for _, outfit in ipairs(allOutfits) do
        if outfit == fit then
            outfitExists = true
            break
        end
    end

    if not outfitExists then
        fit = allOutfits[ZombRand(#allOutfits) + 1]
    end

    if maleOutfits:contains(fit) and femaleOutfits:contains(fit) then
        return fit, 0
    elseif femaleOutfits:contains(fit) then
        return fit, 100
    else
        return fit, 0
    end
end

function DogZedMod.doDespawn(zed)
    if zed:isAlive() then
        zed:setAvoidDamage(false)
        zed:changeState(ZombieOnGroundState.instance())
        zed:setAttackedBy(getCell():getFakeZombieForHit())
        zed:becomeCorpse()

--[[         zed:removeFromWorld();
        zed:removeFromSquare(); ]]
--[[     else
        local sq = zed:getSquare()
        sq:removeCorpse(zed, isClient()); ]]
    end
end

function DogZedMod.doSpawn(sq, isDown, outfit)
    if sq then
        local x, y, z = sq:getX(), sq:getY(), sq:getZ()
        if isClient() then

            local fit, fChance = DogZedMod.getSpawnRandomZedInfo()

            if outfit and outfit ~= '' then
                fit, fChance = DogZedMod.getSpawnRandomZedInfo(outfit)
            end
            sendClientCommand('DogZedMod', 'doSpawn', {x = x, y = y, z = z, count = 1, fit = fit, fChance = fChance, isDown = isDown})
        else
            local x, y, z = sq:getX(), sq:getY(), sq:getZ()
            addZombiesInOutfit(x, y, z, 1, 'myModule1', 100, false, false, false, false, 2);
        end
    end
end

function DogZedMod.doLocalSpawn(sq, outfit)

	local pl = getPlayer()
	local sq = pl:getSquare():getAdjacentSquare(pl:getDir());

    if sq then
        if isClient() then
            SendCommandToServer(string.format("/createhorde2 -x %d -y %d -z %d -count %d -radius %d -crawler %s -isFallOnFront %s -isFakeDead %s -knockedDown %s -health %s -outfit %s ", sq:getX(), sq:getY(), sq:getZ(), 1, 4, tostring(true), tostring(true), tostring(false), tostring(true), tostring(2), "Overgrown"))
            return
        end
	end
	local zed = addZombiesInOutfit(sq:getX(), sq:getY(), sq:getZ(), 1, tostring(outfit), nil, true, true, false, true, 2)
end

