--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


DogZedMod = DogZedMod or {}
local Commands = {};
Commands.DogZedMod = {};

DogZedMod.skin0 = 'Base.RadiatedDog'
DogZedMod.skin1 = 'Base.ShadowDog'
DogZedMod.skin2 = 'Base.CloneDog'

-----------------------            ---------------------------
function DogZedMod.getTargetedZombie(pl)
    local zombies = getCell():getZombieList()
    local targetedZombie = nil
    for i = 0, zombies:size() - 1 do
        local zed = zombies:get(i)
		if DogZedMod.isTarg(pl, zed) then
            targetedZombie = zed
            break
        end
    end

    return targetedZombie
end


function DogZedMod.getDistanceBetween(pl, zed)
    local plX, plY = pl:getX(), pl:getY()
    local zedX, zedY = zed:getX(), zed:getY()
    return math.sqrt((plX - zedX) ^ 2 + (plY - zedY) ^ 2)
end

function DogZedMod.getFov()
    return SandboxVars.DogZedMod.FOV or 50
end

function DogZedMod.isTarg(pl, targ)
	local fov = DogZedMod.getFov()
    local plX, plY = pl:getX(), pl:getY()
    local targX, targY = targ:getX(), targ:getY()

    local targDirX = targX - plX
    local targDirY = targY - plY

	--print(pl:getDotWithForwardDirection(targ:getX(), targ:getY()))
	--local fVec = pl:getForwardDirection()

	 local aimAngle = pl:getLookAngleRadians()

	--local angle = pl:getDirectionAngle()
    local angle = math.atan2(targDirY, targDirX)

    local angleDiff = math.abs(aimAngle - angle)


    if angleDiff > math.pi then
        angleDiff = 2 * math.pi - angleDiff
    end

    local fovInRadians = math.rad(fov) / 2

	--print(angleDiff)
	--print(fovInRadians)

	--print(angle)

    return angleDiff <= fovInRadians
end

------------------------    pl*           ----------

--	local num = DogZedMod.getDayTimeInt()
-----------------------    wear*        ---------------------------
function DogZedMod.wearDogZed(pl, int)
	if not (getCore():getDebug() or isAdmin()) then return end
	DogZedMod.clearDogZedSkin(pl)
	local item = InventoryItemFactory.CreateItem(DogZedMod.skin0)
	if int == 1 then
		item = InventoryItemFactory.CreateItem(DogZedMod.skin1)
	elseif int == 2 then
		item = InventoryItemFactory.CreateItem(DogZedMod.skin2)
	end


	local inv = pl:getInventory()
	local equip = inv:addItem(item);
	pl:setWornItem(equip:getBodyLocation(), equip);
	DogZedMod.setTag(pl, int)
	if not pl:isHideWeaponModel() then pl:setHideWeaponModel(true) end
	triggerEvent("OnClothingUpdated", pl)
	pl:resetModelNextFrame();
end

-----------------------            ---------------------------


-----------------------       ---------------------------



function DogZedMod.clearDogZedSkin(pl)
    local inv = pl:getInventory()
    local skins = {DogZedMod.skin0, DogZedMod.skin1, DogZedMod.skin2}

    for i = inv:getItems():size(), 1, -1 do
        local item = inv:getItems():get(i - 1)
        if item then
            for _, skinType in ipairs(skins) do
                if item:getFullType() == skinType then
                    pl:removeWornItem(item)
                    inv:DoRemoveItem(item)
                    break
                end
            end
        end
    end

    DogZedMod.removeTag(pl)
    pl:setHideWeaponModel(false)
    pl:clearWornItems()
    pl:resetModelNextFrame()
end
-----------------------            ---------------------------


function DogZedMod.wpnHide(pl, wpn)
	local bool = true
	if DogZedMod.isDogPl(pl) then
		bool = true
	else
		bool = false
	end


	pl:setHideWeaponModel(bool)
	JoypadState.disableGrab = bool;
	JoypadState.disableYInventory = bool;
	JoypadState.disableClimbOver = bool;
	JoypadState.disableSmashWindow = bool;
	JoypadState.disableReload = bool;
	ISBackButtonWheel.disableCrafting = bool;
	ISBackButtonWheel.disableMoveable = bool;
	pl:setIgnoreAutoVault(bool);


end
Events.OnEquipPrimary.Add(DogZedMod.wpnHide)
Events.OnEquipSecondary.Add(DogZedMod.wpnHide)
-----------------------            ---------------------------
function DogZedMod.getAdminSkinNum(pl)
	if not pl then return end
	if not instanceof(pl, "IsoPlayer") then return false end
	if not DogZedMod.isDogPl(pl) then return end
	local wornItems = pl:getWornItems()
	if wornItems then
		for i=1, wornItems:size() do
			local item = wornItems:get(i-1):getItem()
			if item:getFullType() == DogZedMod.skin0 then
				return 0
			elseif item:getFullType() == DogZedMod.skin1 then
				return 1
			elseif  item:getFullType() == DogZedMod.skin2 then
				return 2
			end
		end
	end
	return nil
end

-----------------------            ---------------------------
function DogZedMod.isUnarmed(pl, wpn)
	return (tostring(WeaponType.getWeaponType(pl)) == 'barehand' or (wpn and wpn:getCategories():contains("Unarmed"))) or wpn == nil
end

---------------------
function DogZedMod.AdminDogZed(pl)


	if DogZedMod.isDogPl(pl) then
		if pl:getVariableBoolean('isDogPl') == false then
			pl:setVariable('isDogPl', 'true')
			if not pl:isHideWeaponModel() then pl:setHideWeaponModel(true) end
			if isClient() then
				sendClientCommand('DogZedMod', 'isDogPl', {isDogPl = true})
			end
		end
	else
		if pl:getVariableBoolean('isDogPl') == true then
			pl:setVariable('isDogPl', 'false');
			if pl:isHideWeaponModel() then pl:setHideWeaponModel(false) end
			if isClient() then
				sendClientCommand('DogZedMod', 'isDogPl', {isDogPl = false})
			end
		end
	end

end

Events.OnPlayerUpdate.Remove(DogZedMod.AdminDogZed)
Events.OnPlayerUpdate.Add(DogZedMod.AdminDogZed)


--[[
function DogZedMod.AimHandler(pl)

	if pl:isAimKeyDown() then
		local zed = DogZedMod.getTargetedZombie(pl)
		if zed then
			if DogZedMod.isCrying(zed) and DogZedMod.isDogZed(zed) then
				if SandboxVars.DogZedMod.PlayerSympathy then
					if zed:isShootable() then
						zed:setShootable(false)
						--print(zed:isShootable())
					end
					pl:setIgnoreAimingInput(true)
					pl:nullifyAiming()
				end
			end
		end
	else
		pl:setIgnoreAimingInput(false)
	end
end
Events.OnPlayerUpdate.Remove(DogZedMod.AimHandler)
Events.OnPlayerUpdate.Add(DogZedMod.AimHandler)

 ]]

--[[

function DogZedMod.OnKeyKeepPressed(key)
	local pl = getPlayer()
	if key == getCore():getKey("Aim") then
		print(getCore():getKey("Aim"))
		getPlayer():setHaloNote(tostring('test'),150,250,150,900)
		local zed = DogZedMod.getTargetedZombie(pl)
		if zed then
			if DogZedMod.isDogZed(zed) then
				pl:nullifyAiming()
			else

			end
		else

		end
	end
	return key
end
Events.OnKeyKeepPressed.Remove(DogZedMod.OnKeyKeepPressed)
Events.OnKeyKeepPressed.Add(DogZedMod.OnKeyKeepPressed)


 ]]
function DogZedMod.OnLoad()
	local pl = getPlayer(); if not pl then return end
	pl:setIgnoreAimingInput(false)
	if not DogZedMod.isDogPl(pl) then
		pl:setHideWeaponModel(false)
	end
end
Events.OnLoad.Add(DogZedMod.OnLoad)


--[[
Events.OnPlayerDeath.Add(function(pl)
	if not (getCore():getDebug() or isAdmin()) then return end
	local preMod = "isDogPl: "..tostring(isDogPl(pl))
	pl:setVariable('isDogPl', 'false')
	local postMod = "isDogPl: "..tostring(isDogPl(pl))
	local report = tostring(preMod).."\n"..tostring(postMod)
	print(report)
	pl:addLineChatElement(tostring(report))
end)

 ]]

 function DogZedMod.BugPatch(pl)
	local pl = getPlayer()
 	if not (getCore():getDebug() or isAdmin()) then return end
	local preMod = "isDogPl: "..tostring(isDogPl(pl))
	pl:setVariable('isDogPl', 'false')
	local postMod = "isDogPl: "..tostring(isDogPl(pl))
	local report = tostring(preMod).."\n"..tostring(postMod)
	print(report)
	pl:addLineChatElement(tostring(report))
 end
 Events.OnPlayerDeath.Add(DogZedMod.BugPatch)

--[[
Events.OnPlayerDeath.Add(function(pl)
	dataCheck.OnOpenPanel(getPlayer(), "pl")
end)

 ]]
print( getPlayer() )
local pl = getPlayer()
print(isDogPl(pl))

local sq = getPlayer():getSquare();
local corpse = sq:getDeadBody()

dataCheck.OnOpenPanel(corpse, "corpse")
print(isDogPl(corpse))

print(corpse)
print(getPlayer())


local sq = getPlayer():getSquare();
local corpse = sq:getDeadBody()
print(corpse)
dataCheck.OnOpenPanel(corpse, name)

print(getPlayer():getVariableString("isDogPl"))
local sq = getPlayer():getSquare();
local corpse = sq:getDeadBody()
print(corpse)

print(corpse:getVariableString("isDogPl"))
local zPos = getPlayer():getZ()
local xx, yy = ISCoordConversion.ToWorld(getMouseXScaled(), getMouseYScaled(), zPos)
local sq = getCell():getGridSquare(math.floor(xx), math.floor(yy), zPos)
if sq and sq:getFloor() then
	sq:getFloor():setHighlighted(true)
	local zed = sq:getZombie()
	if zed then
		print(zed:getOnlineID())
	end
end
local count = 0
local zeds = getPlayer():getCell():getZombieList()
for i = 0,zeds:size()-1 do
	local zed = zeds:get(i)
	if zed and instanceof(zed, "IsoZombie") then
		count = count + 1 ; print(zed)
	end
end
print(count)


local point = getPlayer()
local rad =8
local cell = point:getCell()
local x, y, z = point:getX(), point:getY(), point:getZ()
for xDelta = -rad, rad do
	for yDelta = -rad, rad do
		local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
		for i=0, sq:getMovingObjects():size()-1 do
			local zed = sq:getMovingObjects():get(i)
			if zed and instanceof(zed, "IsoZombie") then
				--local msg = tostring('test')

				--local msg = (zed:getOutfitName() or "err")
				--zed:Say(msg, 1.0, 1.0, 1.0, UIFont.Small, 30, "radio")


				local msg = ( instanceof(zed, "IsoZombie")  or "err")
				zed:Say(msg, 1.0, 1.0, 1.0, UIFont.Small, 30, "radio")

			end
		end
	end
end



for j=1, sq:getMovingObjects():size() do
	local zed = sq:getMovingObjects():get(j-1)
	if zed and instanceof(zed, "IsoZombie") then
		print(zed:getID()..'  '..zed:getOutfitName())
	end
end