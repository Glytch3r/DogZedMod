--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


DogZedMod = DogZedMod or {}
local Commands = {};
Commands.DogZedMod = {};

DogZedMod.skin0 = 'Base.RadiatedDog'
DogZedMod.skin1 = 'Base.ShadowDog_1'
DogZedMod.skin2 = 'Base.ShadowDog_2'

-----------------------            ---------------------------
function DogZedMod.getTargetedZombie(pl)
    local zombies = getCell():getZombieList()
    local targetedZombie = nil
    for i = 0, zombies:size() - 1 do
        local zed = zombies:get(i)
		if DogZedMod.isTarg(pl, zed) then
            targetedZombie = zed
            break
        end
    end

    return targetedZombie
end


function DogZedMod.getDistanceBetween(pl, zed)
    local plX, plY = pl:getX(), pl:getY()
    local zedX, zedY = zed:getX(), zed:getY()
    return math.sqrt((plX - zedX) ^ 2 + (plY - zedY) ^ 2)
end

function DogZedMod.getFov()
    return SandboxVars.DogZedMod.FOV or 50
end

function DogZedMod.isTarg(pl, targ)
	local fov = DogZedMod.getFov()
    local plX, plY = pl:getX(), pl:getY()
    local targX, targY = targ:getX(), targ:getY()

    local targDirX = targX - plX
    local targDirY = targY - plY

	--print(pl:getDotWithForwardDirection(targ:getX(), targ:getY()))
	--local fVec = pl:getForwardDirection()

	 local aimAngle = pl:getLookAngleRadians()

	--local angle = pl:getDirectionAngle()
    local angle = math.atan2(targDirY, targDirX)

    local angleDiff = math.abs(aimAngle - angle)


    if angleDiff > math.pi then
        angleDiff = 2 * math.pi - angleDiff
    end

    local fovInRadians = math.rad(fov) / 2

	--print(angleDiff)
	--print(fovInRadians)

	--print(angle)

    return angleDiff <= fovInRadians
end

------------------------    pl*           ----------

--	local num = DogZedMod.getDayTimeInt()
-----------------------    wear*        ---------------------------
function DogZedMod.wearDogZed(pl, int)
	if not (getCore():getDebug() or isAdmin()) then return end
	DogZedMod.clearDogZedSkin(pl)
	local item = InventoryItemFactory.CreateItem(DogZedMod.skin0)

	if int == 1 then
		item = InventoryItemFactory.CreateItem(DogZedMod.skin1)
	elseif int == 2 then
		item = InventoryItemFactory.CreateItem(DogZedMod.skin2)
	end


	local inv = pl:getInventory()
	local equip = inv:addItem(item);
	pl:setWornItem(equip:getBodyLocation(), equip);
	DogZedMod.setTag(pl, int)
	if not pl:isHideWeaponModel() then pl:setHideWeaponModel(true) end
	triggerEvent("OnClothingUpdated", pl)
	pl:resetModelNextFrame();
end

-----------------------            ---------------------------


-----------------------       ---------------------------
function DogZedMod.clearDogZedSkin(pl)
	local inv = pl:getInventory()
	for i = inv:getItems():size(), 1, -1 do
		local item = inv:getItems():get(i-1)
		if item and (item:getFullType() == DogZedMod.skin1  or item:getFullType() == DogZedMod.skin2) then
			pl:removeWornItem(item)
			inv:DoRemoveItem(item)
		end
	end
	DogZedMod.removeTag(pl)
	pl:setHideWeaponModel(false)
	pl:clearWornItems();
	pl:resetModelNextFrame();
end
-----------------------            ---------------------------


function DogZedMod.wpnHide(pl, wpn)
	local bool = true
	if DogZedMod.isDogPl(pl) then
		bool = true
	else
		bool = false
	end


	pl:setHideWeaponModel(bool)
	JoypadState.disableGrab = bool;
	JoypadState.disableYInventory = bool;
	JoypadState.disableClimbOver = bool;
	JoypadState.disableSmashWindow = bool;
	JoypadState.disableReload = bool;
	ISBackButtonWheel.disableCrafting = bool;
	ISBackButtonWheel.disableMoveable = bool;
	pl:setIgnoreAutoVault(bool);


end
Events.OnEquipPrimary.Add(DogZedMod.wpnHide)
Events.OnEquipSecondary.Add(DogZedMod.wpnHide)
-----------------------            ---------------------------
function DogZedMod.getAdminSkinNum(pl)
	if not pl then return end
	if not instanceof(pl, "IsoPlayer") then return false end
	if not DogZedMod.isDogPl(pl) then return end
	local wornItems = pl:getWornItems()
	if wornItems then
		for i=1, wornItems:size() do
			local item = wornItems:get(i-1):getItem()
			if item:getFullType() == DogZedMod.skin0 then
				return 0
			elseif item:getFullType() == DogZedMod.skin1 then
				return 1
			elseif  item:getFullType() == DogZedMod.skin2 then
				return 2
			end
		end
	end
	return nil
end

-----------------------            ---------------------------
function DogZedMod.isUnarmed(pl, wpn)
	return (tostring(WeaponType.getWeaponType(pl)) == 'barehand' or (wpn and wpn:getCategories():contains("Unarmed"))) or wpn == nil
end

---------------------
function DogZedMod.AdminDogZed(pl)
	if DogZedMod.isDogPl(pl) then
		if pl:getVariableBoolean('isDogPl') == false then
			pl:setVariable('isDogPl', 'true')
			if not pl:isHideWeaponModel() then pl:setHideWeaponModel(true) end
			if isClient() then
				sendClientCommand('DogZedMod', 'isDogPl', {isDogPl = true})
			end
		end
	else
		if pl:getVariableBoolean('isDogPl') == true then
			pl:setVariable('isDogPl', 'false');
			if pl:isHideWeaponModel() then pl:setHideWeaponModel(false) end
			if isClient() then
				sendClientCommand('DogZedMod', 'isDogPl', {isDogPl = false})
			end
		end
	end

end

Events.OnPlayerUpdate.Remove(DogZedMod.AdminDogZed)
Events.OnPlayerUpdate.Add(DogZedMod.AdminDogZed)


--[[
function DogZedMod.AimHandler(pl)

	if pl:isAimKeyDown() then
		local zed = DogZedMod.getTargetedZombie(pl)
		if zed then
			if DogZedMod.isCrying(zed) and DogZedMod.isDogZed(zed) then
				if SandboxVars.DogZedMod.PlayerSympathy then
					if zed:isShootable() then
						zed:setShootable(false)
						--print(zed:isShootable())
					end
					pl:setIgnoreAimingInput(true)
					pl:nullifyAiming()
				end
			end
		end
	else
		pl:setIgnoreAimingInput(false)
	end
end
Events.OnPlayerUpdate.Remove(DogZedMod.AimHandler)
Events.OnPlayerUpdate.Add(DogZedMod.AimHandler)

 ]]

--[[

function DogZedMod.OnKeyKeepPressed(key)
	local pl = getPlayer()
	if key == getCore():getKey("Aim") then
		print(getCore():getKey("Aim"))
		getPlayer():setHaloNote(tostring('test'),150,250,150,900)
		local zed = DogZedMod.getTargetedZombie(pl)
		if zed then
			if DogZedMod.isDogZed(zed) then
				pl:nullifyAiming()
			else

			end
		else

		end
	end
	return key
end
Events.OnKeyKeepPressed.Remove(DogZedMod.OnKeyKeepPressed)
Events.OnKeyKeepPressed.Add(DogZedMod.OnKeyKeepPressed)


 ]]
function DogZedMod.OnLoad()
	local pl = getPlayer(); if not pl then return end
	pl:setIgnoreAimingInput(false)
	if not DogZedMod.isDogPl(pl) then
		pl:setHideWeaponModel(false)
	end
end
Events.OnLoad.Add(DogZedMod.OnLoad)